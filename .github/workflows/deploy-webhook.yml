name: Deploy Webhooks to Cloud Functions

on:
  push:
    branches: [main]
    paths:
      - 'webhook/**'
      - '.github/workflows/deploy-webhook.yml'
  workflow_dispatch:  # Manual trigger

env:
  PROJECT_ID: smad-pickleball
  REGION: us-west1

jobs:
  deploy-whatsapp-poll-vote-webhook:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy WhatsApp Webhook
        run: |
          gcloud functions deploy smad-whatsapp-webhook \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --runtime=python311 \
            --trigger-http \
            --allow-unauthenticated \
            --entry-point=webhook \
            --source=./webhook \
            --memory=256MB \
            --timeout=60s \
            --gen2 \
            --set-env-vars "SMAD_WHATSAPP_GROUP_ID=${{ vars.SMAD_WHATSAPP_GROUP_ID }},ADMIN_DINKERS_WHATSAPP_GROUP_ID=${{ vars.ADMIN_DINKERS_WHATSAPP_GROUP_ID }},PICKLEBOT_URL=https://${{ env.REGION }}-${{ env.PROJECT_ID }}.cloudfunctions.net/smad-picklebot"

      - name: Get function URL
        run: |
          URL=$(gcloud functions describe smad-whatsapp-webhook \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --gen2 \
            --format='value(serviceConfig.uri)')
          echo "## WhatsApp Webhook Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** \`$URL\`" >> $GITHUB_STEP_SUMMARY

  deploy-picklebot:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Picklebot
        run: |
          gcloud functions deploy smad-picklebot \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --runtime=python311 \
            --gen2 \
            --source=./webhook/picklebot \
            --entry-point=picklebot_webhook \
            --trigger-http \
            --allow-unauthenticated \
            --memory=512MB \
            --timeout=60s \
            --set-env-vars "SMAD_SPREADSHEET_ID=1w4_-hnykYgcs6nyyDkie9CwBRwri7aJUblD2mxgNUHY,SMAD_SHEET_NAME=2026 Pickleball,ADMIN_DINKERS_WHATSAPP_GROUP_ID=${{ vars.ADMIN_DINKERS_WHATSAPP_GROUP_ID }},GITHUB_REPO=genechuang/SMADPickleBot" \
            --set-secrets "ANTHROPIC_API_KEY=ANTHROPIC_API_KEY:latest,GREENAPI_INSTANCE_ID=GREENAPI_INSTANCE_ID:latest,GREENAPI_API_TOKEN=GREENAPI_API_TOKEN:latest,SMAD_GOOGLE_CREDENTIALS_JSON=SMAD_GOOGLE_CREDENTIALS_JSON:latest,GITHUB_TOKEN=GITHUB_TOKEN:latest"

      - name: Get function URL
        run: |
          URL=$(gcloud functions describe smad-picklebot \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --gen2 \
            --format='value(serviceConfig.uri)')
          echo "## Picklebot Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** \`$URL\`" >> $GITHUB_STEP_SUMMARY

  deploy-venmo-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Venmo Sync Trigger
        run: |
          gcloud functions deploy venmo-sync-trigger \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --runtime=python311 \
            --gen2 \
            --source=./webhook/venmo-trigger \
            --entry-point=venmo_email_trigger \
            --trigger-topic=venmo-payment-emails \
            --memory=512MB \
            --timeout=60s \
            --set-env-vars "SMAD_SPREADSHEET_ID=1w4_-hnykYgcs6nyyDkie9CwBRwri7aJUblD2mxgNUHY,SMAD_SHEET_NAME=2026 Pickleball,ADMIN_DINKERS_WHATSAPP_GROUP_ID=${{ vars.ADMIN_DINKERS_WHATSAPP_GROUP_ID }}" \
            --set-secrets "VENMO_ACCESS_TOKEN=VENMO_ACCESS_TOKEN:latest,SMAD_GOOGLE_CREDENTIALS_JSON=SMAD_GOOGLE_CREDENTIALS_JSON:latest,GREENAPI_INSTANCE_ID=GREENAPI_INSTANCE_ID:latest,GREENAPI_API_TOKEN=GREENAPI_API_TOKEN:latest"

      - name: Verify deployment
        run: |
          STATE=$(gcloud functions describe venmo-sync-trigger \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --gen2 \
            --format='value(state)')
          echo "## Venmo Sync Trigger Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "**State:** $STATE" >> $GITHUB_STEP_SUMMARY

  deploy-gha-error-monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy GHA Error Monitor
        run: |
          gcloud functions deploy gha-error-monitor \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --runtime=python311 \
            --gen2 \
            --source=./webhook/gha-error-monitor \
            --entry-point=gha_error_monitor \
            --trigger-http \
            --allow-unauthenticated \
            --memory=256MB \
            --timeout=60s \
            --set-env-vars "GITHUB_REPO=genechuang/SMADPickleBot,ADMIN_DINKERS_WHATSAPP_GROUP_ID=${{ vars.ADMIN_DINKERS_WHATSAPP_GROUP_ID }},ADMIN_PHONE_ID=${{ vars.ADMIN_PHONE_ID }}" \
            --set-secrets "GITHUB_TOKEN=GITHUB_TOKEN:latest,GITHUB_WEBHOOK_SECRET=GITHUB_WEBHOOK_SECRET:latest,ANTHROPIC_API_KEY=ANTHROPIC_API_KEY:latest,GREENAPI_INSTANCE_ID=GREENAPI_INSTANCE_ID:latest,GREENAPI_API_TOKEN=GREENAPI_API_TOKEN:latest"

      - name: Get function URL
        run: |
          URL=$(gcloud functions describe gha-error-monitor \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --gen2 \
            --format='value(serviceConfig.uri)')
          echo "## GHA Error Monitor Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** \`$URL\`" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "Configure this URL as a GitHub webhook with:" >> $GITHUB_STEP_SUMMARY
          echo "- Event: Workflow runs (workflow_run)" >> $GITHUB_STEP_SUMMARY
          echo "- Content type: application/json" >> $GITHUB_STEP_SUMMARY
